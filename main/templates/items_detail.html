{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>{{ items.title }} - All about Football</title>
<link rel="icon" type="image/png" href="{% static 'images/LSlogo.png' %}">
{% endblock meta %}

{% block content %}
<div class="bg-[#e0f2ff] w-full min-h-screen">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Back Navigation -->
    <div class="mb-6">
      <a href="{% url 'main:show_main' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
        ← Back to Items
      </a>
    </div>
    
    <!-- Article -->
    <article class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      
      <!-- Header -->
      <div class="p-6 sm:p-8">
        <div class="flex items-center justify-between mb-4">
          <!-- Left: Category badges -->
          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-blue-600 text-white">
              {{ items.get_category_display }}
            </span>
            {% if items.is_featured %}
              <span class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800">
                Featured
              </span>
            {% endif %}
            {% if items.is_items_hot %}
              <span class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-red-100 text-red-800">
                Hot
              </span>
            {% endif %}
          </div>

          <!-- Right: Date -->
          <time datetime="{{ items.created_at|date:'c' }}" class="text-sm text-gray-500">
            {{ items.created_at|date:"M j, Y g:i A" }}
          </time>
        </div>

        <!-- ✅ Action buttons (only for the owner) -->
        {% if user.is_authenticated and items.user == user %}
          <div class="flex items-center justify-between pt-4 border-t border-gray-100 mt-6">
            <div class="flex space-x-2">
              <a href="{% url 'main:edit_items' items.id %}" 
                 class="text-gray-600 hover:text-gray-700 text-sm transition-colors">
                Edit
              </a>
              <a href="{% url 'main:delete_items' items.id %}" 
                 class="text-red-600 hover:text-red-700 text-sm transition-colors">
                Delete
              </a>
            </div>
          </div>
        {% endif %}
      </div>


      <!-- Featured Image + Content -->
      {% if items.thumbnail %}
      <div class="px-6 sm:px-8 flex justify-left">
        <div class="flex flex-col md:flex-row md:items-start md:space-x-8">
          <div class="flex-shrink-0">
            <div class="w-64 h-96 overflow-hidden rounded-lg">
              <img src="{{ items.thumbnail }}" 
                   alt="{{ items.title }}" 
                   class="w-full h-full object-cover">
            </div>
          </div>

          <div class="mt-6 md:mt-0 flex-1">
            <h1 class="text-3xl font-semibold text-blue-900 mb-2">{{ items.title }}</h1>
            <p class="text-2xl font-bold text-blue-600 mb-4">Rp {{ items.price|intcomma }}</p>
            <div class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg">
              {{ items.content }}
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="px-6 sm:px-8">
        <div class="mt-6 flex-1">
          <h1 class="text-3xl font-semibold text-blue-900 mb-2">{{ items.title }}</h1>
          <p class="text-2xl font-bold text-blue-600 mb-4">Rp {{ items.price|intcomma }}</p>
          <div class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg">
            {{ items.content }}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Author Info -->
      <div class="border-t border-gray-200 p-6 sm:p-8 bg-gray-50">
        <div class="flex items-center justify-left">
          <div>
            <div class="font-medium text-gray-900">
              {% if items.user %}
                <p>Listed by: {{ items.user.username }}</p>
              {% else %}
                <p>Listed by: Anonymous</p>
              {% endif %}
            </div>
            <p class="text-sm text-gray-500">Views: {{ items.store_views }}</p>
          </div>
        </div>
      </div>
    </article>
  </div>
</div>

<script>
// Configuration
const ITEM_ID = "{{ items.id }}";
const ITEM_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`
  .replace('00000000-0000-0000-0000-000000000000', ITEM_ID);

// DOM Elements
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const articleContent = document.getElementById('article-content');
const badgesContainer = document.getElementById('badges-container');
const articleTitle = document.getElementById('article-title');
const articleDate = document.getElementById('article-date');
const articleViews = document.getElementById('article-views');
const featuredImageContainer = document.getElementById('featured-image-container');
const featuredImage = document.getElementById('featured-image');
const articleContentText = document.getElementById('article-content-text');
const articleAuthor = document.getElementById('article-author');

// Show/hide states
function showState(state) {
  loadingState.classList.toggle('hidden', state !== 'loading');
  errorState.classList.toggle('hidden', state !== 'error');
  articleContent.classList.toggle('hidden', state !== 'ready');
}

// Get readable category name (sesuai model kamu)
function getCategoryLabel(code) {
  const map = {
    jersey: 'Jersey',
    shoes: 'Shoes',
    sock: 'Sock',
    shorts: 'Shorts',
    new: 'New Arrival',
  };
  return map[code] || code || '';
}

// Format price (IDR)
function formatPrice(value) {
  const n = Number(value) || 0;
  return 'Rp ' + n.toLocaleString('id-ID');
}

// Escape HTML content (prevent XSS)
function escapeHtml(raw) {
  if (!raw) return '';
  const div = document.createElement('div');
  div.textContent = raw;
  return div.innerHTML.replace(/\n/g, '<br>');
}

// Render item detail
function renderItem(item) {
  // Title
  articleTitle.textContent = item.title || 'Untitled';
  document.title = `${item.title || 'Item'} - Lilywhite Store`;

  // Badges (category, featured, hot)
  badgesContainer.innerHTML = '';
  const catBadge = document.createElement('span');
  catBadge.className =
    'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-blue-600 text-white';
  catBadge.textContent = getCategoryLabel(item.category);
  badgesContainer.appendChild(catBadge);

  if (item.is_featured) {
    const f = document.createElement('span');
    f.className =
      'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800 ml-2';
    f.textContent = 'Featured';
    badgesContainer.appendChild(f);
  }

  if ((item.store_views || 0) > 20) {
    const h = document.createElement('span');
    h.className =
      'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-red-100 text-red-800 ml-2';
    h.textContent = 'Hot';
    badgesContainer.appendChild(h);
  }

  // Date & views
  if (item.created_at) {
    const d = new Date(item.created_at);
    const formatted = d.toLocaleString('id-ID', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
    articleDate.textContent = formatted;
  } else {
    articleDate.textContent = '';
  }
  articleViews.textContent = `${item.store_views || 0} views`;

  // Image
  if (item.thumbnail) {
    featuredImage.src = item.thumbnail;
    featuredImage.alt = item.title;
    featuredImageContainer.classList.remove('hidden');
  } else {
    featuredImageContainer.classList.add('hidden');
  }

  // Content & price
  const priceHtml = `<p class="text-2xl font-bold text-blue-600 mb-4">${formatPrice(
    item.price
  )}</p>`;
  articleContentText.innerHTML =
    priceHtml + (item.content ? escapeHtml(item.content) : '');

  // Author
  const authorName = item.user_username || 'Anonymous';
  articleAuthor.textContent = `Listed by: ${authorName}`;
}

// Fetch detail data
async function loadItemDetail() {
  try {
    showState('loading');
    const res = await fetch(ITEM_DETAIL_ENDPOINT, {
      headers: { Accept: 'application/json' },
    });
    if (!res.ok) throw new Error('Failed to fetch item detail');
    const data = await res.json();
    renderItem(data);
    showState('ready');
  } catch (err) {
    console.error('Error loading item detail:', err);
    showState('error');
  }
}

// Initialize
loadItemDetail();
</script>

{% endblock content %}
