{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Lilywhite Store</title>
<link rel="icon" type="image/png" href="{% static 'images/LSlogo.png' %}">
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-[#e0f2ff] w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <div class="w-full rounded-lg px-6 py-10 text-white bg-gradient-to-r from-blue-900 to-blue-400">
        <h1 class="text-3xl font-bold mb-2">Latest Football Items</h1>
        <p class="text-blue-100">Stay updated with the latest football gears</p>
      </div>
      <!-- Button to open modal -->
   
    </div>
     <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-white text-blue-600 font-semibold outline outline-2 outline-blue-600 outline-offset-[-2px] rounded-md hover:bg-blue-600 hover:text-white transition-colors mb-4">
      Quick Add Item
    </button>

    <button onclick="fetchItemsFromServer()"
  class="inline-flex items-center px-4 py-2 bg-white text-blue-600 font-semibold outline outline-2 outline-blue-600 outline-offset-[-2px] rounded-md hover:bg-blue-600 hover:text-white transition-colors mb-4">
  Refresh Items
</button>

    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-gradient-to-r from-blue-900 to-blue-300 rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?" class="{% if request.GET.filter == 'all' or not request.GET.filter %} bg-blue-600 text-white{% else %} bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white">
          All Items
        </a>
        <a href="?filter=my" class="{% if request.GET.filter == 'my' %} bg-blue-600 text-white{% else %} bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white">
          My Items
        </a>
      </div>

      {% if user.is_authenticated %}
        <div class="text-sm text-white">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <!-- Items Grid / Empty State -->
    {% if not items_list %}
      <div class="bg-white rounded-lg border border-gray-200 p-12 text-center">
        <div class="w-32 h-32 mx-auto mb-4">
          <img src="{% static 'images/no-items.png' %}" alt="No Items available" class="w-full h-full object-contain">
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Items found</h3>
        <p class="text-gray-500 mb-6">Be the first to share football items with the community.</p>
        <a href="{% url 'main:create_items' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          Create items
        </a>
      </div>
    {% else %}
      <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for items in items_list %}
          {% include 'card_items.html' with items=items %}
        {% endfor %}
      </div>
    {% endif %}

  </div>

  <button
    onclick="showToast('Need Help?', 'Contact our support team for assistance.')"
    class="fixed bottom-6 right-6 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-blue-700 transition-colors"
  >
    Help
  </button>
</div>

<script>
// ============================
// CONFIGURATION
// ============================
const ITEMS_API_ENDPOINT = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// ============================
// DOM ELEMENTS
// ============================
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const itemsGridContainer = document.getElementById('grid');
const showAllItemsButton = document.getElementById('filter-all');
const showMyItemsButton = document.getElementById('filter-my');

// ============================
// STATE VARIABLES
// ============================
let activeFilter = 'all';
let allItemsData = [];

// ============================
// HELPER FUNCTIONS
// ============================

// Category name mapping
function getCategoryName(categoryCode) {
  const map = {
    jersey: 'Jersey',
    shoes: 'Shoes',
    sock: 'Sock',
    shorts: 'Shorts',
    new: 'New Arrival'
  };
  return map[categoryCode] || categoryCode;
}

// Format price into IDR
function formatPrice(value) {
  const n = Number(value) || 0;
  return 'Rp ' + n.toLocaleString('id-ID');
}

// Update filter button appearance
function updateFilterButtonsAppearance() {
  if (!showAllItemsButton || !showMyItemsButton) return;

  if (activeFilter === 'all') {
    showAllItemsButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700';
    showMyItemsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white';
  } else {
    showMyItemsButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700';
    showAllItemsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white';
  }
}

// Show/hide sections
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  itemsGridContainer.classList.toggle('hidden', !showGrid);
  if (showGrid) {
    itemsGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}

// ============================
// BUILD CARD ELEMENT
// ============================
function buildItemCardElement(item) {
    const article = document.createElement('article');
    article.className =
      'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

    // Dynamic URL replacements
    const linkDetail = `{% url 'main:show_items' '00000000-0000-0000-0000-000000000000' %}`.replace(
      '00000000-0000-0000-0000-000000000000',
      item.id
    );
    const linkEdit = `{% url 'main:edit_items' '00000000-0000-0000-0000-000000000000' %}`.replace(
      '00000000-0000-0000-0000-000000000000',
      item.id
    );
    const linkDelete = `{% url 'main:delete_items' '00000000-0000-0000-0000-000000000000' %}`.replace(
      '00000000-0000-0000-0000-000000000000',
      item.id
    );

    // Sanitized data
    const title = DOMPurify.sanitize(item.title);
    const price = DOMPurify.sanitize(item.price);
    const content = DOMPurify.sanitize(item.content);
    const category = DOMPurify.sanitize(item.category);
    const thumbnail = DOMPurify.sanitize(item.thumbnail);
    const createdAt = DOMPurify.sanitize(
      new Date(item.created_at).toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      })
    );
    const storeViews = DOMPurify.sanitize(item.store_views);
    const isFeatured = item.is_featured;
    const isHot = storeViews > 20;

    // Category display mapping
    const categoryMap = {
      jersey: 'Jersey',
      shoes: 'Shoes',
      sock: 'Sock',
      shorts: 'Shorts',
      new: 'New Arrival',
    };
    const categoryLabel = DOMPurify.sanitize(categoryMap[category] || category);

    // Thumbnail & badges
    const thumbnailHtml = DOMPurify.sanitize(
      item.thumbnail
        ? `<img src='${thumbnail}' alt='${title}' class='w-full h-full object-cover'>`
        : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-500'>No Image</div>`
    );
    const featuredBadge = isFeatured
      ? DOMPurify.sanitize(
          `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>`
        )
      : '';
    const hotBadge = isHot
      ? DOMPurify.sanitize(
          `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800'>Hot</span>`
        )
      : '';

    // Action buttons (for owner only)
    const editDeleteHtml =
      CURRENT_USER_ID && String(CURRENT_USER_ID) === String(item.user_id)
        ? `<div class='flex space-x-2'>
              <a href='${linkEdit}' class='text-gray-600 hover:text-gray-700 text-sm transition-colors'>Edit</a>
              <a href='${linkDelete}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Yakin ingin menghapus item ini?")'>Delete</a>
            </div>`
        : '';

    // Final card HTML
    const cardHtml = `
        <div class="aspect-[16/9] relative overflow-hidden">
          ${thumbnailHtml}
          <div class="absolute top-3 left-3">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white">${categoryLabel}</span>
          </div>
          <div class="absolute top-3 right-3 flex space-x-2">
            ${featuredBadge}
            ${hotBadge}
          </div>
        </div>
        <div class="p-5 flex flex-col flex-1">
          <div class="flex items-center text-sm text-gray-500 mb-3">
            <time>${createdAt}</time>
            <span class="mx-2">â€¢</span>
            <span>${storeViews} views</span>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2 leading-tight">
            <a href="${linkDetail}" class="hover:text-blue-600 transition-colors">${title}</a>
          </h3>
          <p class="text-blue-600 font-bold mb-2">Rp ${Number(price).toLocaleString('id-ID')}</p>
          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${content}</p>
          <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
            <a href="${linkDetail}" class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors">View</a>
            ${editDeleteHtml}
          </div>
        </div>
    `;

    article.innerHTML = cardHtml;
    return article;
}

function prependItemToGrid(item) {
  // jika grid ter-hidden karena empty state, pastikan tampilkan grid
  if (itemsGridContainer.classList.contains('hidden')) {
    displayPageSection({ showGrid: true });
  }

  const card = buildItemCardElement(item);
  card.id = `card-${item.id}`;
  // insert di posisi paling atas
  if (itemsGridContainer.firstChild) {
    itemsGridContainer.insertBefore(card, itemsGridContainer.firstChild);
  } else {
    itemsGridContainer.appendChild(card);
  }
}



// ============================
// RENDER ALL CARDS
// ============================
function renderAllItems(items) {
  itemsGridContainer.innerHTML = '';
  items.forEach(item => {
    const card = buildItemCardElemet(item);
    itemsGridContainer.appendChild(card);
  });
}

// ============================
// FILTER & DISPLAY
// ============================
function filterAndDisplayItems() {
  updateFilterButtonsAppearance();

  const filtered = activeFilter === 'all'
    ? allItemsData
    : allItemsData.filter(i => String(i.user_id) === String(CURRENT_USER_ID));

  if (filtered.length === 0) {
    displayPageSection({ showEmpty: true });
  } else {
    renderAllItems(filtered);
    displayPageSection({ showGrid: true });
  }
}

// ============================
// FETCH ITEMS FROM SERVER
// ============================
async function fetchItemsFromServer() {
  try {
    displayPageSection({ showLoading: true });

    const response = await fetch(ITEMS_API_ENDPOINT, { headers: { 'Accept': 'application/json' } });
    if (!response.ok) throw new Error('Failed to fetch items');

    allItemsData = await response.json();
    filterAndDisplayItems();

    // optional: beri feedback pengguna
    // showToast('Items refreshed', 'Latest items loaded', 'success');
  } catch (error) {
    console.error('Error loading items:', error);
    displayPageSection({ showError: true });
  }
}


// ============================
// EVENT HANDLERS
// ============================
function handleShowAllItemsClick() {
  activeFilter = 'all';
  filterAndDisplayItems();
}

function handleShowMyItemsClick() {
  activeFilter = 'my';
  filterAndDisplayItems();
}

// ============================
// INITIALIZE PAGE
// ============================
function initializeItemsPage() {
  showAllItemsButton.addEventListener('click', handleShowAllItemsClick);
  showMyItemsButton.addEventListener('click', handleShowMyItemsClick);
  fetchItemsFromServer();
}

// Start
initializeItemsPage();
// Add event listener to detect new items
// saat ada event itemsAdded, gunakan detail bila tersedia
document.addEventListener('itemsAdded', function(e) {
  const data = e?.detail || null;
  if (data && data.item) {
    // backend returned the created/updated item -> update DOM accordingly
    // kalau item baru: prepend
    if (data.status === 'created' || data.item) {
      prependItemToGrid(data.item);
    } else if (data.status === 'updated') {
      // update existing card in-place (optional)
      // simplest: refetch whole list
      fetchItemsFromServer();
    } else if (data.deleted) {
      // if delete action passed deleted id, remove DOM
      const card = document.getElementById(`card-${data.deleted}`);
      if (card) card.remove();
    } else {
      fetchItemsFromServer();
    }
  } else {
    // no detail -> fallback to re-fetch
    fetchItemsFromServer();
  }
});




</script>

{% endblock content %}
